# Server Configuration Reference

## Setup

```bash
muxi-server init    # Generate config + auth credentials (save them!)
muxi-server start   # Start on port 7890
muxi-server status  # Check status
```

## Config File

Location: `~/.muxi/server/config.yaml` (Homebrew/user) or `/etc/muxi/server/config.yaml` (system).

```yaml
server:
  port: 7890              # Default MUXI port
  host: 0.0.0.0           # 0.0.0.0 = all interfaces, 127.0.0.1 = localhost only
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s

auth:
  enabled: true           # Always true for production
  keys:
    - id: MUXI_e8f3a9b2
      secret: sk_...      # Generated by init
    # Multiple keys for different clients:
    - id: MUXI_ci
      secret: sk_ci_...

formations:
  port_range: [8000, 9000]  # Ports assigned to formations
  auto_restart: true
  max_restarts: 5
  restart_delay: 5s
  health_check_interval: 30s
  health_check_timeout: 5s
  unhealthy_threshold: 3
  startup_timeout: 60s

logging:
  level: info             # debug, info, warn, error
  format: json            # json or text
  output: stdout          # stdout or file path

runtime:
  auto_download: true     # Download runtime SIF if missing
  version: latest         # Pin with e.g. "1.0.0"
```

## Environment Variable Overrides

| Variable | Config Path |
|----------|-------------|
| `MUXI_PORT` | `server.port` |
| `MUXI_HOST` | `server.host` |
| `MUXI_AUTH_ENABLED` | `auth.enabled` |
| `MUXI_LOG_LEVEL` | `logging.level` |

## Authentication (HMAC)

Management endpoints (`/rpc/*`) require HMAC-SHA256 signatures:

```
Authorization: MUXI-HMAC key={KEY_ID}, timestamp={UNIX_TIME}, signature={BASE64_HMAC_SHA256}
```

**Signature generation:**
1. Build message: `"{timestamp};{method};{path}"`
2. Sign: `HMAC-SHA256(secret_key, message)`
3. Encode: `base64(signature)`

The CLI handles this automatically. Only needed for direct API calls.

## Server API Endpoints

### Public (no auth)

| Method | Path | Description |
|--------|------|-------------|
| GET | `/health` | Health check (`{"status": "ok"}`) |
| GET | `/ping` | Connectivity test (returns "pong") |

### Management (HMAC auth)

| Method | Path | Description |
|--------|------|-------------|
| POST | `/rpc/formations` | Deploy formation (gzip tarball) |
| GET | `/rpc/formations` | List all formations |
| GET | `/rpc/formations/{id}` | Get formation details |
| PUT | `/rpc/formations/{id}` | Update formation (blue-green deploy) |
| DELETE | `/rpc/formations/{id}` | Delete formation |
| POST | `/rpc/formations/{id}/start` | Start stopped formation |
| POST | `/rpc/formations/{id}/stop` | Stop running formation |
| POST | `/rpc/formations/{id}/restart` | Restart formation |
| POST | `/rpc/formations/{id}/rollback` | Rollback to previous version |
| POST | `/rpc/formations/{id}/cancel-update` | Cancel in-progress update |
| GET | `/rpc/formations/{id}/logs` | Get logs (`?follow=true` for SSE) |
| GET | `/rpc/server/status` | Server status and stats |
| GET | `/rpc/server/logs` | Server audit logs |

### Proxy (formation handles auth)

| Method | Path | Description |
|--------|------|-------------|
| ANY | `/api/{formation_id}/*` | Transparent proxy to formation |

### Deployment

Deploy with `Content-Type: application/gzip` and `X-Formation-ID` header. Add `Accept: text/event-stream` for live SSE progress updates.

**Deploy stages:** extracting -> validating -> resolving_runtime -> downloading_sif -> pulling_runner -> spawning -> health_check

**Update uses blue-green deployment:** old version keeps running until new passes health checks. Rollback available via `/rpc/formations/{id}/rollback`.

### Response Format

**Success:**
```json
{
  "success": true,
  "data": { ... }
}
```

**Error:**
```json
{
  "error": "ValidationError",
  "message": "Formation 'my-team' already exists",
  "code": 409
}
```

## Running as a Service

### macOS (launchd)

```bash
cat > ~/Library/LaunchAgents/ai.muxi.server.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key><string>ai.muxi.server</string>
    <key>ProgramArguments</key>
    <array><string>/opt/homebrew/bin/muxi-server</string><string>serve</string></array>
    <key>RunAtLoad</key><true/>
    <key>KeepAlive</key><true/>
</dict>
</plist>
EOF
launchctl load ~/Library/LaunchAgents/ai.muxi.server.plist
```

### Linux (systemd)

```ini
[Unit]
Description=MUXI Server
After=network.target

[Service]
Type=simple
User=muxi
Group=muxi
ExecStart=/usr/local/bin/muxi-server serve
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

```bash
sudo useradd -r -s /bin/false muxi
sudo systemctl daemon-reload
sudo systemctl enable muxi-server
sudo systemctl start muxi-server
sudo journalctl -u muxi-server -f  # View logs
```

### Docker Compose (Production)

```yaml
version: '3.8'
services:
  muxi-server:
    image: ghcr.io/muxi-ai/server:latest
    ports: ["7890:7890"]
    volumes:
      - muxi-data:/data
      - ./config:/etc/muxi:ro
      - ./formations:/formations:ro
    environment:
      - MUXI_AUTH_ENABLED=true
      - MUXI_LOG_LEVEL=info
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7890/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
volumes:
  muxi-data:
```

Docker credential init: `docker exec muxi-server muxi-server init`

## Cross-Platform Runtime

| Platform | Runtime | Notes |
|----------|---------|-------|
| Linux | Singularity (SIF) | Native, no Docker needed |
| macOS | Docker (via runtime-runner) | Requires Docker Desktop |
| Windows | Docker (via runtime-runner) | Requires Docker Desktop |
